<%- include('../includes/shop/shopHead.ejs') %>
    <%- include('../includes/shop/shopHeader.ejs') %>

        <div class="p-0 p-md-5">
            <div class="container-fluid">
                <div class="wishlist-container mt-5 font-poppins">
                    <h5 class="mx-5">WishList</h5>
                    <div class="vstack gap-2 mt-4">
                        <%if (wishlist) {%>
                            <% wishlist.products.forEach(function(product){%>
                        <div class="card">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center part-1">
                                    <div class="image-div"
                                    style="background-image: url('/images/product-images/<%=product.images[0]%>'); height: 8rem ; width: 8rem; background-size: cover; background-position: top; position: relative;">
                                </div>
                                <div class="product-details d-flex flex-column justify-content-center ms-3">
                                    <h6 class="card-title" style="text-transform: capitalize;">
                                        <%=product.productName%>
                                    </h6>
                                    <p class="card-text">
                                        <%=product.description%>
                                    </p>
                                    <strong class="text-danger-emphasis mt-3"><span>â‚¹</span>
                                        <%=product.price%>
                                    </strong>
                                </div>
                                </div>
                                <div class="d-flex align-items-center part-2">
                                    <div class="options-div me-5">
                                        <div class="size-div mb-3">
                                            <select name="sizeOptions" id="sizeOptions" class="form-select form-select-sm sizeOptions" style="text-transform: capitalize;">
                                                <%product.sizeOptions.forEach(function(size){%>
                                                <option value="<%=size%>" style="text-transform: capitalize;"><%=size%></option>
                                                <%})%>
                                            </select>
                                        </div>
                                        <div class="color-div">
                                            <select name="color" id="colorOptions" class="form-select form-select-sm colorOptions" style="text-transform: capitalize;">
                                                <%product.color.forEach(function(clr){%>
                                                <option value="<%=clr%>" style="text-transform: capitalize;"><%=clr%></option>
                                                <%})%>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column">
                                        <button class="btn btn-primary btn-sm mb-2 addToCart">Add To Cart</button>
                                        <button class="btn btn-outline-primary btn-sm mb-2">Buy Now</button>
                                        <button class="btn btn-outline-danger btn-sm removeitemBtn" data-productId="<%=product._id%>">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <%} )%>
                        <%}%>
                        
                    </div>
                </div>
            </div>
        </div>

       
            <%- include('../includes/shop/shopFooter.ejs') %>
                <script>
                    const removeBtns = document.querySelectorAll('.removeitemBtn');
                    const addToCartBtns = document.querySelectorAll('.addToCart');

                    addToCartBtns.forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            const productId = btn.getAttribute('data-productId');
                            if (productId) {
                                const url = `/wishlist/fetchproductoptions/${productId}`
                                const method = 'GET'
                                const body = {}
                                const response = await fetch(url, {
                                    method: method,
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                const productData = await response.json()

                                if (productData.status === true) {
                                    const sizeOptionsPreview = document.querySelector('.size-options-preview');
                                    const colorOptionsPreview = document.querySelector('.colorOptionsPreview');
                                    const productNamePreview = document.querySelector('.productName');
                                    const addToCartBtn = document.getElementById('addToCartBtn');
                                    sizeOptionsPreview.innerHTML = ''
                                    colorOptionsPreview.innerHTML = ''
                                    productNamePreview.innerText = productData.product.productName
                                    addToCartBtn.setAttribute('data-productId', productId)
                                    productData.product.sizeOptions.forEach((size) => {
                                        const sizeOption = `<div class="ms-1 mb-1 mb-lg-0 ">
                            <input type="radio" class="btn-check " id="${size}" autocomplete="off"
                                name="sizeOption" value="${size}">
                            <label for="${size}" class="btn btn-outline-primary btn-sm"
                                style="text-transform: capitalize;">
                                ${size}
                            </label>
                        </div>`

                                        sizeOptionsPreview.innerHTML += sizeOption;
                                    })

                                    productData.product.color.forEach((colr) => {
                                        const colorOption = `<div class="ms-1 mb-1 mb-lg-0">
                            <input type="radio" class="btn-check" id="${colr}"
                                autocomplete="off" name="color" value="${colr}">
                            <label for="${colr}" class="btn btn-outline-primary btn-sm"
                                style="text-transform: capitalize;">
                                ${colr}
                            </label>
                        </div>`

                                        colorOptionsPreview.innerHTML += colorOption;
                                    });
                                    optionModalTrigger.click()
                                }
                            }
                        })
                    })

                    removeBtns.forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            Swal.fire({
                                title: "Are you sure?",
                                text: "You want to remove product from wishlist",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: "#d33",
                                cancelButtonText: "No, Cancel",
                                confirmButtonText: "Yes, Remove!"
                            }).then(async (result) => {
                                if (result.isConfirmed) {
                                    const productId = btn.getAttribute('data-productId');
                                    console.log(productId);
                                    const url = '/wishlist/remove'
                                    const method = 'PATCH'
                                    const body = {
                                        productId: productId
                                    }
                                    const data = await fetchFunction(url, method, body);
                                    if (data.status === true) {
                                        Swal.fire({
                                            text: data.message,
                                            icon: "success"
                                        }).then(() => {
                                            location.reload()
                                        })
                                    }
                                }
                            });

                        })
                    })

                    async function fetchFunction(url, method, body) {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(body)
                        })

                        const data = await response.json()

                        return data;
                    }

                    function addToCart(colorOptionValue, sizeOptionValue, productId) {
                        let hasError = false
                        console.log(colorOptionValue, sizeOptionValue, productId);
                    }

                    function setError(element, message) {
                        const inputParent = element.closest('.parent');
                        const errorDisplay = inputParent.querySelector('.error');

                        errorDisplay.innerText = message;
                    }
                </script>
                <%- include('../includes/shop/shopEnd.ejs') %>